<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management (React)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif']
                    },
                    animation: {
                        'spin-slow': 'spin 1.5s linear infinite',
                    }
                }
            }
        }
    </script>
    <!-- 2. Load React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* A little extra style for transitions */
        .message-box {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 1;
            transform: translateY(0);
        }
        .message-box.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
        /* Style for active nav link */
        .nav-link.active {
            @apply bg-indigo-700 text-white;
        }
        /* Tailwind base styles */
        body {
            @apply bg-gray-100 font-sans antialiased;
        }

        /* Custom reusable form/button classes */
        @layer components {
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500;
            }
            .form-select {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500;
            }
            .btn {
                @apply w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50;
            }
            .card {
                @apply bg-white p-6 md:p-8 rounded-lg shadow-lg;
            }
            .table-th {
                @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
            }
            .table-td {
                @apply px-6 py-4 whitespace-nowrap text-sm;
            }
            .table-row {
                @apply hover:bg-gray-50;
            }
        }
    </style>
</head>
<body>
<!-- 3. This is where our React app will live -->
<div id="root"></div>

<!-- 4. This is our entire React Application -->
<script type="text/babel">

    const { useState, useEffect, useCallback, Fragment } = React;

    // --- Reusable SVG Icons ---
    const SpinnerIcon = () => (
        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    );

    const GlobalSpinner = () => (
        <div className="flex justify-center items-center h-64">
            <svg className="animate-spin-slow h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    );

    // --- Global Message Component ---
    function MessageBox({ message, isError, onDismiss }) {
        useEffect(() => {
            if (message) {
                const timer = setTimeout(() => {
                    onDismiss();
                }, 4000);
                return () => clearTimeout(timer);
            }
        }, [message, onDismiss]);

        if (!message) return null;

        const baseClasses = 'p-4 mb-6 rounded-md';
        const errorClasses = 'bg-red-100 text-red-700';
        const successClasses = 'bg-green-100 text-green-700';

        return (
            <div className={`message-box ${baseClasses} ${isError ? errorClasses : successClasses}`}>
                <p>{message}</p>
            </div>
        );
    }

    // --- Navigation Component ---
    function Navbar({ activePage, onNavigate }) {
        const navItems = [
            { id: 'workorders', name: 'Work Orders' },
            { id: 'properties', name: 'Properties' },
            { id: 'vendors', name: 'Vendors' }
        ];

        return (
            <nav className="bg-indigo-600 shadow-lg">
                <div className="container mx-auto max-w-5xl px-4">
                    <div className="flex justify-between items-center py-4">
                        <div className="text-white text-xl font-bold">Property Manager</div>
                        <div className="flex space-x-2">
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => onNavigate(item.id)}
                                    className={`nav-link px-3 py-2 rounded-md text-sm font-medium text-indigo-100 hover:bg-indigo-700 hover:text-white ${activePage === item.id ? 'active' : ''}`}
                                >
                                    {item.name}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            </nav>
        );
    }

    // --- Work Order Page Component ---
    function WorkOrderPage({ properties, vendors, workOrders, showMessage, onReload }) {
        const [propertyId, setPropertyId] = useState('');
        const [vendorId, setVendorId] = useState('');
        const [description, setDescription] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setIsSubmitting(true);

            let url = `/api/workorders?propertyId=${propertyId}`;
            if (vendorId) {
                url += `&vendorId=${vendorId}`;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error: ${response.statusText}`);
                }

                const newWorkOrder = await response.json();
                showMessage(`Success! Work Order #${newWorkOrder.id} created.`, false);
                setPropertyId('');
                setVendorId('');
                setDescription('');
                onReload(); // Reload the work orders table
            } catch (error) {
                showMessage(error.message, true);
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div>
                <h1 className="text-3xl font-bold text-gray-800 mb-6">Manage Work Orders</h1>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    {/* Create Work Order Form */}
                    <div className="md:col-span-1">
                        <div className="card">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">New Work Order</h2>
                            <form id="workorder-form" onSubmit={handleSubmit}>
                                <div className="space-y-6">
                                    <div>
                                        <label htmlFor="property" className="form-label">Property</label>
                                        <select
                                            id="property-select"
                                            required
                                            className="form-select"
                                            value={propertyId}
                                            onChange={(e) => setPropertyId(e.target.value)}
                                        >
                                            <option value="">Select a property</option>
                                            {properties.map(prop => (
                                                <option key={prop.id} value={prop.id}>
                                                    {`${prop.address} (${prop.type || 'N/A'})`}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label htmlFor="vendor" className="form-label">Assign Vendor (Optional)</label>
                                        <select
                                            id="vendor-select"
                                            className="form-select"
                                            value={vendorId}
                                            onChange={(e) => setVendorId(e.target.value)}
                                        >
                                            <option value="">(Optional) Assign a vendor</option>
                                            {vendors.map(vendor => (
                                                <option key={vendor.id} value={vendor.id}>
                                                    {`${vendor.name} (${vendor.serviceType || 'N/A'})`}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label htmlFor="description" className="form-label">Description</label>
                                        <textarea
                                            id="description-input"
                                            rows="4"
                                            required
                                            className="form-input"
                                            placeholder="e.g., Fix leaky faucet in Unit 101"
                                            value={description}
                                            onChange={(e) => setDescription(e.target.value)}
                                        ></textarea>
                                    </div>
                                    <div>
                                        <button type="submit" disabled={isSubmitting} className="btn">
                                            {isSubmitting && <SpinnerIcon />}
                                            {isSubmitting ? 'Submitting...' : 'Submit Work Order'}
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    {/* Work Orders Table */}
                    <div className="md:col-span-2">
                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                <tr>
                                    <th className="table-th">Property</th>
                                    <th className="table-th">Status</th>
                                    <th className="table-th">Description</th>
                                    <th className="table-th">Vendor</th>
                                </tr>
                                </thead>
                                <tbody id="workorders-table-body" className="bg-white divide-y divide-gray-200">
                                {workOrders.length === 0 ? (
                                    <tr><td colSpan="4" className="px-6 py-4 text-center text-gray-500">No work orders found.</td></tr>
                                ) : (
                                    workOrders.map(wo => (
                                        <tr key={wo.id} className="table-row">
                                            <td className="table-td font-medium text-gray-900">{wo.property?.address || 'N/A'}</td>
                                            <td className="table-td">
                                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                            wo.status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                                                                wo.status === 'COMPLETE' ? 'bg-green-100 text-green-800' :
                                                                    'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {wo.status}
                                                        </span>
                                            </td>
                                            <td className="table-td text-gray-500">{wo.description}</td>
                                            <td className="table-td text-gray-500">{wo.vendor?.name || 'Unassigned'}</td>
                                        </tr>
                                    ))
                                )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // --- Properties Page Component ---
    function PropertiesPage({ properties, showMessage, onReload }) {
        const [address, setAddress] = useState('');
        const [type, setType] = useState('');
        const [bedrooms, setBedrooms] = useState(1);
        const [bathrooms, setBathrooms] = useState(1);
        const [isSubmitting, setIsSubmitting] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setIsSubmitting(true);
            const requestBody = { address, type, bedrooms: parseInt(bedrooms), bathrooms: parseInt(bathrooms) };

            try {
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.errors) {
                        const errorMsg = Object.values(errorData.errors).join(', ');
                        throw new Error(errorMsg);
                    }
                    throw new Error(errorData.message || `Error: ${response.statusText}`);
                }

                showMessage('Property created successfully!', false);
                setAddress('');
                setType('');
                setBedrooms(1);
                setBathrooms(1);
                onReload(); // Trigger a reload of all properties
            } catch (error) {
                showMessage(error.message, true);
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div>
                <h1 className="text-3xl font-bold text-gray-800 mb-6">Manage Properties</h1>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    {/* Create Property Form */}
                    <div className="md:col-span-1">
                        <div className="card">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">Add New Property</h2>
                            <form id="property-form" onSubmit={handleSubmit}>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="prop-address" className="form-label">Address</label>
                                        <input type="text" id="prop-address" required value={address} onChange={(e) => setAddress(e.target.value)} className="form-input" />
                                    </div>
                                    <div>
                                        <label htmlFor="prop-type" className="form-label">Type</label>
                                        <input type="text" id="prop-type" required value={type} onChange={(e) => setType(e.target.value)} className="form-input" placeholder="e.g., Single Family" />
                                    </div>
                                    <div>
                                        <label htmlFor="prop-bedrooms" className="form-label">Bedrooms</label>
                                        <input type="number" id="prop-bedrooms" min="0" required value={bedrooms} onChange={(e) => setBedrooms(e.target.value)} className="form-input" />
                                    </div>
                                    <div>
                                        <label htmlFor="prop-bathrooms" className="form-label">Bathrooms</label>
                                        <input type="number" id="prop-bathrooms" min="1" required value={bathrooms} onChange={(e) => setBathrooms(e.target.value)} className="form-input" />
                                    </div>
                                    <button type="submit" disabled={isSubmitting} className="btn">
                                        {isSubmitting && <SpinnerIcon />}
                                        {isSubmitting ? 'Adding...' : 'Add Property'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {/* Properties Table */}
                    <div className="md:col-span-2">
                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                <tr>
                                    <th className="table-th">Address</th>
                                    <th className="table-th">Type</th>
                                    <th className="table-th">Beds/Baths</th>
                                </tr>
                                </thead>
                                <tbody id="properties-table-body" className="bg-white divide-y divide-gray-200">
                                {properties.length === 0 ? (
                                    <tr><td colSpan="3" className="px-6 py-4 text-center text-gray-500">No properties found. Add one!</td></tr>
                                ) : (
                                    properties.map(prop => (
                                        <tr key={prop.id} className="table-row">
                                            <td className="table-td font-medium text-gray-900">{prop.address}</td>
                                            <td className="table-td text-gray-500">{prop.type}</td>
                                            <td className="table-td text-gray-500">{prop.bedrooms || 0}/{prop.bathrooms || 0}</td>
                                        </tr>
                                    ))
                                )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // --- Vendors Page Component ---
    function VendorsPage({ vendors, showMessage, onReload }) {
        const [name, setName] = useState('');
        const [serviceType, setServiceType] = useState('');
        const [phoneNumber, setPhoneNumber] = useState('');
        const [email, setEmail] = useState('');
        const [isSubmitting, setIsSubmitting] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setIsSubmitting(true);
            const requestBody = { name, serviceType, phoneNumber, email };

            try {
                const response = await fetch('/api/vendors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.errors) {
                        const errorMsg = Object.values(errorData.errors).join(', ');
                        throw new Error(errorMsg);
                    }
                    throw new Error(errorData.message || `Error: ${response.statusText}`);
                }

                showMessage('Vendor created successfully!', false);
                setName('');
                setServiceType('');
                setPhoneNumber('');
                setEmail('');
                onReload(); // Trigger a reload of all vendors
            } catch (error) {
                showMessage(error.message, true);
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div>
                <h1 className="text-3xl font-bold text-gray-800 mb-6">Manage Vendors</h1>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    {/* Create Vendor Form */}
                    <div className="md:col-span-1">
                        <div className="card">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">Add New Vendor</h2>
                            <form id="vendor-form" onSubmit={handleSubmit}>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="vendor-name" className="form-label">Name</label>
                                        <input type="text" id="vendor-name" required value={name} onChange={e => setName(e.target.value)} className="form-input" placeholder="e.g., Bob's Plumbing" />
                                    </div>
                                    <div>
                                        <label htmlFor="vendor-specialty" className="form-label">Specialty</label>
                                        <input type="text" id="vendor-specialty" required value={serviceType} onChange={e => setServiceType(e.target.value)} className="form-input" placeholder="e.g., Plumbing" />
                                    </div>
                                    <div>
                                        <label htmlFor="vendor-phone" className="form-label">Phone</label>
                                        <input type="tel" id="vendor-phone" value={phoneNumber} onChange={e => setPhoneNumber(e.target.value)} className="form-input" />
                                    </div>
                                    <div>
                                        <label htmlFor="vendor-email" className="form-label">Email</label>
                                        <input type="email" id="vendor-email" value={email} onChange={e => setEmail(e.target.value)} className="form-input" />
                                    </div>
                                    <button type="submit" disabled={isSubmitting} className="btn">
                                        {isSubmitting && <SpinnerIcon />}
                                        {isSubmitting ? 'Adding...' : 'Add Vendor'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {/* Vendors Table */}
                    <div className="md:col-span-2">
                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                <tr>
                                    <th className="table-th">Name</th>
                                    <th className="table-th">Specialty</th>
                                    <th className="table-th">Contact</th>
                                </tr>
                                </thead>
                                <tbody id="vendors-table-body" className="bg-white divide-y divide-gray-200">
                                {vendors.length === 0 ? (
                                    <tr><td colSpan="3" className="px-6 py-4 text-center text-gray-500">No vendors found. Add one!</td></tr>
                                ) : (
                                    vendors.map(vendor => (
                                        <tr key={vendor.id} className="table-row">
                                            <td className="table-td font-medium text-gray-900">{vendor.name}</td>
                                            <td className="table-td text-gray-500">{vendor.specialty}</td>
                                            <td className="table-td text-gray-500">{vendor.phone || vendor.email || 'N/A'}</td>
                                        </tr>
                                    ))
                                )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // --- Main App Component ---
    function App() {
        // State
        const [activePage, setActivePage] = useState('workorders');
        const [properties, setProperties] = useState([]);
        const [vendors, setVendors] = useState([]);
        const [workOrders, setWorkOrders] = useState([]);
        const [message, setMessage] = useState('');
        const [isError, setIsError] = useState(false);
        const [isLoading, setIsLoading] = useState(true); // Global loading state

        // Show message helper
        const showMessage = (msg, error = false) => {
            setMessage(msg);
            setIsError(error);
        };

        // API Call: Load Properties
        const loadProperties = useCallback(async () => {
            const response = await fetch('/api/properties');
            if (!response.ok) throw new Error('Failed to fetch properties');
            const data = await response.json();
            setProperties(data);
        }, []);

        // API Call: Load Vendors
        const loadVendors = useCallback(async () => {
            const response = await fetch('/api/vendors');
            if (!response.ok) throw new Error('Failed to fetch vendors');
            const data = await response.json();
            setVendors(data);
        }, []);

        // API Call: Load Work Orders
        const loadWorkOrders = useCallback(async () => {
            const response = await fetch('/api/workorders');
            if (!response.ok) throw new Error('Failed to fetch work orders');
            const data = await response.json();
            setWorkOrders(data);
        }, []);

        // Load all data on initial component mount
        useEffect(() => {
            async function loadInitialData() {
                try {
                    setIsLoading(true);
                    // Run all fetch requests in parallel
                    await Promise.all([
                        loadProperties(),
                        loadVendors(),
                        loadWorkOrders()
                    ]);
                } catch (error) {
                    showMessage(error.message, true);
                } finally {
                    setIsLoading(false);
                }
            }
            loadInitialData();
        }, [loadProperties, loadVendors, loadWorkOrders]);

        // Render the correct page
        let currentPage;
        if (isLoading) {
            currentPage = <GlobalSpinner />;
        } else {
            switch (activePage) {
                case 'properties':
                    currentPage = <PropertiesPage properties={properties} showMessage={showMessage} onReload={loadProperties} />;
                    break;
                case 'vendors':
                    currentPage = <VendorsPage vendors={vendors} showMessage={showMessage} onReload={loadVendors} />;
                    break;
                case 'workorders':
                default:
                    currentPage = <WorkOrderPage
                        properties={properties}
                        vendors={vendors}
                        workOrders={workOrders}
                        showMessage={showMessage}
                        onReload={loadWorkOrders}
                    />;
            }
        }

        return (
            <Fragment>
                <Navbar activePage={activePage} onNavigate={setActivePage} />
                <div className="container mx-auto max-w-5xl px-4 py-12">
                    <MessageBox message={message} isError={isError} onDismiss={() => setMessage('')} />
                    {currentPage}
                </div>
            </Fragment>
        );
    }

    // 5. Render the App to the root div
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>

